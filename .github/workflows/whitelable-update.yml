name: Release

on:
  push:
    tags:
      - '*'
    branches: [main]
  repository_dispatch:
    types: [whitelabel-update]
      
#   release:
#     types: [created]

jobs:
  set_tag:
    name: Set latest release tag in env
    runs-on: ubuntu-latest
    outputs:
      latest_tag: ${{ steps.latest_tag.outputs.LATEST_RELEASE_TAG }}
    steps:
      - uses: actions/checkout@v2

      - id: latest_tag
        run: echo "::set-output name=LATEST_RELEASE_TAG::$(git describe --tags `git rev-list --tags --max-count=1`)"
        
      - uses: actions/upload-artifact@v2
        name: Upload Artifact
        with:
          name: url
          path: "https://testint.newgenpayments.com/client/html/Success.html?txnRef=REF1655971187863"
          
  github-release:
    name: Github Release
    runs-on: ubuntu-latest
    needs: [set_tag]
    steps:
      - uses: actions/download-artifact@v2
        with:
          name: url

      - id: releaseprep
        run: |
          cat >$CHANGELOG <<-EOD
          Release ${{needs.set_tag.outputs.latest_tag}}
          Downloads available:
          EOD
          cat url-* >> $CHANGELOG
        env:
          CHANGELOG: release.txt

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release.txt
          tag_name: ${{ needs.set_tag.outputs.latest_tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#   get_tag:
#     name: Update Tags
#     needs: [set_tag]
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v2
      
#       - name: Get Latest Tag
#         run: echo "${{needs.set_tag.outputs.latest_tag}}"

#         run: echo "$(git describe --tags `git rev-list --tags --max-count=1`)"

